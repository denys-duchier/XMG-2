%token syn
%token string
%token id
%token node
%token int
%token bool

%type Var Var
%type SynStmts SynStmts
%type SynStmt SynStmt
%type Node Node
%type MaybeProps MaybeProps
%type Props Props
%type Feat Feat
%type Dom Dom
%type DomOp DomOp
%type Prec Prec
%type PrecOp PrecOp
%type IdOrNode IdOrNode
%type Eq Eq
%type Expr Expr
%type Tree Tree
%type Children Children
%type Child Child
%type TreePrecOp TreePrecOp
%type TreeDomOp TreeDomOp

%ext AVM AVM

%%

SynStmts : SynStmt {$$=$1}
	 | SynStmts ';' SynStmts {$$=and($1,$3)}
	 | SynStmts '|' SynStmts {$$=or($1,$3)}
	 | '{' SynStmts '}' {$$=$2};

SynStmt :  Node | Dom | Prec | Eq | Tree;

Node : node (Var)? MaybeProps (AVM)? {$$=node($2,$3,$4)};

MaybeProps : '(' Props ')' {$$=some($2)}
	   | {$$=none};

Props : (Feat // ',')+ {$$=$1};
	 
Feat : id '=' id {$$=feat($1,$3)}
     | id '=' int {$$=feat($1,$3)}
     | id '=' bool {$$=feat($1,$3)}
     | id {$$=feat($1)};

Dom : IdOrNode DomOp IdOrNode {$$=dom($2,$1,$3)};

IdOrNode : Node {$$=$1} 
	 | Var {$$=$1};

DomOp : '->' {$$=$1} 
      | '->+'{$$=$1} 
      | '->*'{$$=$1} ;

Prec : IdOrNode PrecOp IdOrNode {$$=prec($2,$1,$3)};

PrecOp : '>>' {$$=$1} 
       | '>>+'{$$=$1}  
       | '>>*'{$$=$1} ;

Tree : Node '{' Children '}' {$$=tree($1,$3)};

Children : Child {$$=children($1,none)} 
	 | Child TreePrecOp Children {$$=children($1,brothers($2,$3))};

Child : TreeDomOp Node {$$=child($1,$2)} 
      | TreeDomOp Tree {$$=child($1,$2)};

TreePrecOp : ',,,' {$$=$1}
	   | ',,,+'{$$=$1} 
	   | {$$=none};

TreeDomOp : '...' {$$=$1}
	  | '...+'{$$=$1}
	  | {$$=none};

Eq : Expr '=' Expr {$$=eq($1,$3)};

Expr : id {$$=$1} 
     | string {$$=$1};

Var : id | '?' id;

%%
